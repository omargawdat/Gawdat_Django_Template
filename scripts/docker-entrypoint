#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

# Wait for PostgreSQL
# Extract host and port from DATABASE_URL (format: postgis://user:pass@host:port/dbname)  # pragma: allowlist secret
if [[ "$DATABASE_URL" =~ @([^:]+):([0-9]+)/ ]]; then
    DB_HOST="${BASH_REMATCH[1]}"
    DB_PORT="${BASH_REMATCH[2]}"
    wait-for-it "${DB_HOST}:${DB_PORT}" -t 30
    >&2 echo 'PostgreSQL is available'
fi

# If arguments are provided, execute them
if [ "$#" -gt 0 ]; then
    exec "$@"
fi

# Run common Django setup tasks
python manage.py migrate
python manage.py loadcountries --download-flags
python manage.py loadzones
python manage.py createsu
python manage.py createcachetable

# Dispatch to environment-specific script for final setup and server startup
if [ "$IS_LOCAL" = "true" ]; then
    # Local development environment
    exec /scripts/docker-entrypoint.local
elif [ "${ENVIRONMENT:-}" = "development" ]; then
    # Development server environment
    exec /scripts/docker-entrypoint.dev
else
    # Production/staging environment (default)
    exec /scripts/docker-entrypoint.prod
fi
